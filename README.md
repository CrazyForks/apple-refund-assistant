## apple-refund-assistant
![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/seth-shi/apple-refund-assistant/laravel.yml)
![Codecov](https://img.shields.io/codecov/c/github/seth-shi/apple-refund-assistant)
![CodeRabbit Pull Request Reviews](https://img.shields.io/coderabbit/prs/github/seth-shi/apple-refund-assistant?utm_source=oss&utm_medium=github&utm_campaign=seth-shi%2Fapple-refund-assistant&labelColor=171717&color=FF570A&link=https%3A%2F%2Fcoderabbit.ai&label=CodeRabbit+Reviews)

English | [ÁÆÄ‰Ωì‰∏≠Êñá](./README.zh.md) | [Espa√±ol](./README.es.md) | [‡§π‡§ø‡§®‡•ç‡§¶‡•Ä](./README.hi.md) | [ÿßŸÑÿπÿ±ÿ®Ÿäÿ©](./README.ar.md) | [Portugu√™s](./README.pt.md) | [–†—É—Å—Å–∫–∏–π](./README.ru.md) | [Êó•Êú¨Ë™û](./README.ja.md) | [Fran√ßais](./README.fr.md)

This service is built on Laravel / Filament multi-tenant architecture,
effectively helping developers prevent fraudulent refunds by instantly processing Apple's CONSUMPTION_REQUEST notifications and asynchronously returning consumption data.

- **Multi-tenant Support**
- **Multi-language Support** (‰∏≠Êñá / English / Espa√±ol / ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä / ÿßŸÑÿπÿ±ÿ®Ÿäÿ© / Portugu√™s / –†—É—Å—Å–∫–∏–π / Êó•Êú¨Ë™û / Fran√ßais)
- **Multi-currency Support**
- **Zero Dependencies File+SQLite** `or upgrade to Redis+MySQL`
- **100% Test Coverage**
- **Self-managed App Keys** Private keys are only stored in your database `apps` table (with symmetric encryption, keys generated by your application)
- **12 Consumption Fields** - [Calculate all required Apple fields](#consumption-field-strategy)
- **Notification Message Forwarding** Apple server sends to current service, current service forwards to your production server


## Online Demo

üåê **Demo URL**: [https://apple-refund-assistant.shiguopeng.cn/](https://apple-refund-assistant.shiguopeng.cn/)

> ‚ö†Ô∏è **Note**: The system resets every 30 minutes.

 
## Screenshots
![Homepage](assets/0.png)
![Homepage](assets/1.png)
![Homepage](assets/2.png)
![Homepage](assets/3.png)
![Homepage](assets/4.png)
![Homepage](assets/5.png)


## Quick Start
### Using Pre-built Image
```bash
docker run -d \
  -p 8080:8080 \
  --name apple-refund-assistant \
  --restart=always \
  ghcr.io/seth-shi/apple-refund-assistant:latest
```


### Local Build and Run
```bash
git clone https://github.com/seth-shi/apple-refund-assistant
cd apple-refund-assistant
## Build image and deploy
./deploy.sh
```

### If you need to mount data
```
touch database.sqlite
docker run -d \
  -p 8080:8080 \
  -v $(pwd)/database.sqlite:/var/www/html/database/database.sqlite \
  --name apple-refund-assistant \
  --restart=always \
  ghcr.io/seth-shi/apple-refund-assistant:latest
```

## Consumption Field Strategy
* Documentation: [https://developer.apple.com/documentation/appstoreserverapi/consumptionrequest](https://developer.apple.com/documentation/appstoreserverapi/consumptionrequest)
* Strategy Code: [ConsumptionService.php](./app/Services/ConsumptionService.php) 
* `users` table fields can be updated by other systems

| Field                       | Description                | Data Source                          | Calculation Rule                                                                                           |
|--------------------------|-------------------|--------------------------------|------------------------------------------------------------------------------------------------|
| accountTenure            | User registration days            | `users.register_at`            | Current time minus registration time                                                                                     |
| appAccountToken          | Account token          | `users.app_account_token`      | [Needs to be passed when client creates order](https://developer.apple.com/documentation/StoreKit/Transaction/appAccountToken) |
| consumptionStatus        | Consumption status              | `transactions.expiration_date` | Compare with current time, if expired return consumed                                                                              |
| customerConsented        | User consent to provide data          | None                              | Hardcoded `true`                                                                                       |
| deliveryStatus           | Whether successfully delivered a functional in-app purchase. | None                              | Hardcoded `0`(normal delivery)                                                                                    |
| lifetimeDollarsPurchased | Total in-app purchase amount             | `users.purchased_dollars`      | Accumulate this field based on Apple transaction events, you can also accumulate it yourself                                                                        |
| lifetimeDollarsRefunded  | Total refund amount             | `users.refunded_dollars`       | Accumulate this field based on Apple refund events, you can also accumulate it yourself                                                                        |
| platform                 | Platform                | None                              | Hardcoded `1`(apple)                                                                                   |
| playTime                 | Customer app usage time value        | `users.play_seconds`           | Your system needs to support updating this field, otherwise it's `0`                                                                          |
| refundPreference         | Expected result of refund request         | `transactions.expiration_date` | Compare with current time, if expired hope to reject refund                                                                             |
| sampleContentProvided    | Whether trial is provided            | `apps.sample_content_provided` | Configure app when creating app                                                                                      |
| userStatus               | User status              | None                              | Hardcoded `1`(normal user)                                                                                   |

## Future Plans
- Have other ideas or interested in collaboration? Please submit an issue on GitHub - we look forward to your feedback!

## Acknowledgments
* [Rates By Exchange Rate API](https://www.exchangerate-api.com)
* [https://github.com/argus-sight/refund-swatter-lite](https://github.com/argus-sight/refund-swatter-lite)
